---
title: "Problem Set 3"
author: "Zachary Brandt"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Weather and Witch Killing

```{r include=FALSE}
killing <- read.csv('/Users/zachary/Documents/GitHub/econ172/pset3/data/q1.csv')
```

Construct a new variable for the total number of murders in a village-year 
(witch + non-witch murders).

```{r a}
killing$total_murders <- killing$witch_murders + killing$oth_murders
```

Create a table of summary statistics for all variables in the dataset, 
including the mean, standard deviation, minimum, maximum, and number of 
observations, using stargazer, summary or describe commands in R. Discuss any 
noteworthy patterns. Pay particular attention to the murder and rainfall 
variables.

```{r b}
summary(killing)
```

Now consider the effect of extreme weather on murders in the village.

Install “miceadds” and “sandwich”. Using the lm.cluster command, regress total
murders (in a village in a particular year) on the indicator for whether a 
drought or flood occurred in that year. Make sure that error terms should be 
allowed to be correlated ("clustered") across years for the same village (use 
vid). Simply use summary to report the results in this question.
[Note: Results estimated by lm.cluster could not be exported directly with
stargazer so we use summary for simplicity. In the section we will teach how to
export clustered regression results in a neater way.]

```{r ci, message=FALSE}
library(miceadds)
library(sandwich)
model <- lm.cluster(data = killing, total_murders ~ any_rain, cluster = "vid")
summary(model)
```

In a second regression, add average years of schooling and proportion of 
households practicing traditional religions as additional explanatory variables.

```{r cii}
model <- lm.cluster(data = killing, total_murders ~ any_rain + educat + 
                      trad_relig, cluster = "vid")
summary(model)
```

Finally, consider a possible instrumental variables (IV) approach. Economic 
theory suggests that extreme economic hardship-such as a famine-may be 
associated with more violence, including murders. Famine may be caused by 
extreme rainfall (which would be the instrumental variable).

Write out the first stage regression, the second stage regression, and the 
reduced form regression.

```{r d, eval=FALSE}
# First stage regression
any_rain ~ famine

# Second stage regression
total_murders ~ any_rain + educat + trad_relig

# Reduced form regression
total_murders ~ famine + educat + trad_relig
```

## The Primary School Deworming Project (PSDP)

```{r include=FALSE}
deworming <- read.csv('/Users/zachary/Documents/GitHub/econ172/pset3/data/q2.csv')
controls <- "saturation_dm + demeaned_popT_6k + zoneidI2 + zoneidI3 + zoneidI4 + 
             zoneidI5 + zoneidI6 + zoneidI7 + zoneidI8 + pup_pop + 
             month_interviewI2 + month_interviewI3 + month_interviewI4 + 
             month_interviewI5 + month_interviewI6 + month_interviewI7 + 
             month_interviewI8 + month_interviewI9 + month_interviewI10 + 
             month_interviewI11 + month_interviewI12 + cost_sharing + 
             std98_base_I2 + std98_base_I3 + std98_base_I4 + std98_base_I5 + 
             std98_base_I6 + female_baseline + avgtest96"
```

```{r include=FALSE, message=FALSE}
library(stargazer)
library(multiwayvcov)
```

Use R to estimate regressions in the format of the following. Simply use 
summary to report the results in this question. To receive full credits, please 
highlight the names of dependent variables and estimated coefficients of 
treatment with red rectangles. You could do this by annotating the pdf document 
compiled from .rmd or exported from Microsoft Word. 

name_dep_var = treatment + name_control_vars, with “weight” as the sampling
weight and “psdpsch98” as the cluster ID

```{r ai-totyrs_enrolled}
model <- lm.cluster(data = deworming, 
                    formula = as.formula(paste("totyrs_enrolled ~ treatment +", controls)), 
                    cluster = "psdpsch98", 
                    weights = deworming$weight)
summary(model)
```

```{r ai-passed_primary_exam}
model <- lm.cluster(data = deworming, 
                    formula = as.formula(paste("passed_primary_exam ~ treatment +", controls)),
                    cluster = "psdpsch98",
                    weights = deworming$weight)
summary(model)
```

```{r ai-num_meals_yesterday}
model <- lm.cluster(data = deworming, 
                    formula = as.formula(paste("num_meals_yesterday ~ treatment +", controls)),
                    cluster = "psdpsch98",
                    weights = deworming$weight)
summary(model)
```

```{r ai-total_hours}
# Regression 4: Total hours worked
model <- lm.cluster(data = deworming, 
                     formula = as.formula(paste("total_hours ~ treatment +", controls)),
                     cluster = "psdpsch98",
                     weights = deworming$weight)
summary(model)
```

```{r ai-ln_emp_salary_total}
model <- lm.cluster(data = deworming, 
                     formula = as.formula(paste("ln_emp_salary_total ~ treatment +", controls)),
                     cluster = "psdpsch98",
                     weights = deworming$weight)
summary(model)
```

```{r stargazer-ai, results='hide', include=FALSE}
# Stargazer tables for question a.i with clustered standard errors
library(stargazer)
library(multiwayvcov)

# Run all five regressions using standard lm with weights
m1 <- lm(as.formula(paste("totyrs_enrolled ~ treatment +", controls)), 
         data = deworming, weights = weight)
m2 <- lm(as.formula(paste("passed_primary_exam ~ treatment +", controls)), 
         data = deworming, weights = weight)
m3 <- lm(as.formula(paste("num_meals_yesterday ~ treatment +", controls)), 
         data = deworming, weights = weight)
m4 <- lm(as.formula(paste("total_hours ~ treatment +", controls)), 
         data = deworming, weights = weight)
m5 <- lm(as.formula(paste("ln_emp_salary_total ~ treatment +", controls)), 
         data = deworming, weights = weight)

# Calculate clustered standard errors for each model
V1 <- cluster.vcov(m1, deworming$psdpsch98)
V2 <- cluster.vcov(m2, deworming$psdpsch98)
V3 <- cluster.vcov(m3, deworming$psdpsch98)
V4 <- cluster.vcov(m4, deworming$psdpsch98)
V5 <- cluster.vcov(m5, deworming$psdpsch98)

cl_se1 <- sqrt(diag(V1))
cl_se2 <- sqrt(diag(V2))
cl_se3 <- sqrt(diag(V3))
cl_se4 <- sqrt(diag(V4))
cl_se5 <- sqrt(diag(V5))

# Generate stargazer table
stargazer(m1, m2, m3, m4, m5,
          se = list(cl_se1, cl_se2, cl_se3, cl_se4, cl_se5),
          type = "latex",
          keep.stat = c("n", "rsq"),
          keep = c("treatment")
          )
```

Deworming benefits might be stronger for certain groups — for instance, girls 
(perhaps because they were more likely to be infected) or children with lower 
BMI at baseline (because they were less healthy initially).

Please estimate whether the deworming treatment had a differential impact on
totyrs_enrolled, passed_primary_exam, and total_hours by gender
(female_baseline) and then by BMI (BMI). To receive full credits, please
highlight the names of dependent variables and estimated coefficients of
interactive terms with red rectangles.

```{r bi-totyrs_enrolled-gender}
model <- lm.cluster(data = deworming, 
                    formula = as.formula(paste("totyrs_enrolled ~ treatment * female_baseline +", controls)),
                    cluster = "psdpsch98",
                    weights = deworming$weight)
summary(model)
```

```{r bi-passed_primary_exam-gender}
model <- lm.cluster(data = deworming, 
                     formula = as.formula(paste("passed_primary_exam ~ treatment * female_baseline +", controls)),
                     cluster = "psdpsch98",
                     weights = deworming$weight)
summary(model)
```

```{r bi-total_hours-gender}
model <- lm.cluster(data = deworming, 
                     formula = as.formula(paste("total_hours ~ treatment * female_baseline +", controls)),
                     cluster = "psdpsch98",
                     weights = deworming$weight)
summary(model)
```

```{r bi-totyrs_enrolled-BMI}
model <- lm.cluster(data = deworming, 
                    formula = as.formula(paste("totyrs_enrolled ~ treatment * BMI +", controls)),
                    cluster = "psdpsch98",
                    weights = deworming$weight)
summary(model)
```

```{r bi-passed_primary-exam-BMI}
model <- lm.cluster(data = deworming, 
                      formula = as.formula(paste("passed_primary_exam ~ treatment * BMI +", controls)),
                      cluster = "psdpsch98",
                      weights = deworming$weight)
summary(model)
```

```{r bi-total_hours-BMI}
model <- lm.cluster(data = deworming, 
                      formula = as.formula(paste("total_hours ~ treatment * BMI +", controls)),
                      cluster = "psdpsch98",
                      weights = deworming$weight)
summary(model)
```

```{r stargazer-bi-gender, results='hide', include=FALSE}
# Stargazer tables for question b.i - Gender interactions
library(stargazer)
library(multiwayvcov)

# Run gender interaction regressions using standard lm with weights
m1_gender <- lm(as.formula(paste("totyrs_enrolled ~ treatment * female_baseline +", controls)),
                data = deworming, weights = weight)
m2_gender <- lm(as.formula(paste("passed_primary_exam ~ treatment * female_baseline +", controls)),
                data = deworming, weights = weight)
m3_gender <- lm(as.formula(paste("total_hours ~ treatment * female_baseline +", controls)),
                data = deworming, weights = weight)

# Calculate clustered standard errors
V1_gender <- cluster.vcov(m1_gender, deworming$psdpsch98)
V2_gender <- cluster.vcov(m2_gender, deworming$psdpsch98)
V3_gender <- cluster.vcov(m3_gender, deworming$psdpsch98)

cl_se1_gender <- sqrt(diag(V1_gender))
cl_se2_gender <- sqrt(diag(V2_gender))
cl_se3_gender <- sqrt(diag(V3_gender))

# Generate stargazer table
stargazer(m1_gender, m2_gender, m3_gender,
          se = list(cl_se1_gender, cl_se2_gender, cl_se3_gender),
          type = "latex",
          keep.stat = c("n", "rsq"),
          keep = c("treatment", "female_baseline", "treatment:female_baseline")
          )
```

```{r stargazer-bi-BMI, results='hide', include=FALSE}
# Stargazer tables for question b.i - BMI interactions
library(stargazer)
library(multiwayvcov)

# Run BMI interaction regressions using standard lm with weights
m1_bmi <- lm(as.formula(paste("totyrs_enrolled ~ treatment * BMI +", controls)),
             data = deworming, weights = weight)
m2_bmi <- lm(as.formula(paste("passed_primary_exam ~ treatment * BMI +", controls)),
             data = deworming, weights = weight)
m3_bmi <- lm(as.formula(paste("total_hours ~ treatment * BMI +", controls)),
             data = deworming, weights = weight)

# Calculate clustered standard errors
V1_bmi <- cluster.vcov(m1_bmi, deworming$psdpsch98)
V2_bmi <- cluster.vcov(m2_bmi, deworming$psdpsch98)
V3_bmi <- cluster.vcov(m3_bmi, deworming$psdpsch98)

cl_se1_bmi <- sqrt(diag(V1_bmi))
cl_se2_bmi <- sqrt(diag(V2_bmi))
cl_se3_bmi <- sqrt(diag(V3_bmi))

# Generate stargazer table
stargazer(m1_bmi, m2_bmi, m3_bmi,
          se = list(cl_se1_bmi, cl_se2_bmi, cl_se3_bmi),
          type = "latex",
          keep.stat = c("n", "rsq"),
          keep = c("treatment", "BMI", "treatment:BMI")
          )
```

